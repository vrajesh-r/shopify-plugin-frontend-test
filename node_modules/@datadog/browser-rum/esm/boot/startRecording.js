import { __assign } from "tslib";
import { LifeCycleEventType } from '@datadog/browser-rum-core';
import { record } from '../domain/record';
import { startSegmentCollection } from '../domain/segmentCollection';
import { send } from '../transport/send';
import { RecordType } from '../types';
export function startRecording(lifeCycle, applicationId, configuration, session, parentContexts) {
    var _a = startSegmentCollection(lifeCycle, applicationId, session, parentContexts, function (data, meta, rawSegmentSize) { return send(configuration.sessionReplayEndpoint, data, meta, rawSegmentSize); }), addRecord = _a.addRecord, stopSegmentCollection = _a.stop;
    function addRawRecord(rawRecord) {
        addRecord(__assign(__assign({}, rawRecord), { timestamp: Date.now() }));
    }
    var _b = record({
        emit: addRawRecord,
    }), stopRecording = _b.stop, takeFullSnapshot = _b.takeFullSnapshot, flushMutations = _b.flushMutations;
    lifeCycle.subscribe(LifeCycleEventType.VIEW_ENDED, flushMutations);
    lifeCycle.subscribe(LifeCycleEventType.VIEW_CREATED, takeFullSnapshot);
    trackViewEndRecord(lifeCycle, function (record) { return addRawRecord(record); });
    return {
        stop: function () {
            stopRecording();
            stopSegmentCollection();
        },
    };
}
export function trackViewEndRecord(lifeCycle, addRawRecord) {
    lifeCycle.subscribe(LifeCycleEventType.VIEW_ENDED, function () {
        addRawRecord({
            type: RecordType.ViewEnd,
        });
    });
}
//# sourceMappingURL=startRecording.js.map