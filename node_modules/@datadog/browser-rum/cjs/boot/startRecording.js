"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.trackViewEndRecord = exports.startRecording = void 0;
var tslib_1 = require("tslib");
var browser_rum_core_1 = require("@datadog/browser-rum-core");
var record_1 = require("../domain/record");
var segmentCollection_1 = require("../domain/segmentCollection");
var send_1 = require("../transport/send");
var types_1 = require("../types");
function startRecording(lifeCycle, applicationId, configuration, session, parentContexts) {
    var _a = segmentCollection_1.startSegmentCollection(lifeCycle, applicationId, session, parentContexts, function (data, meta, rawSegmentSize) { return send_1.send(configuration.sessionReplayEndpoint, data, meta, rawSegmentSize); }), addRecord = _a.addRecord, stopSegmentCollection = _a.stop;
    function addRawRecord(rawRecord) {
        addRecord(tslib_1.__assign(tslib_1.__assign({}, rawRecord), { timestamp: Date.now() }));
    }
    var _b = record_1.record({
        emit: addRawRecord,
    }), stopRecording = _b.stop, takeFullSnapshot = _b.takeFullSnapshot, flushMutations = _b.flushMutations;
    lifeCycle.subscribe(browser_rum_core_1.LifeCycleEventType.VIEW_ENDED, flushMutations);
    lifeCycle.subscribe(browser_rum_core_1.LifeCycleEventType.VIEW_CREATED, takeFullSnapshot);
    trackViewEndRecord(lifeCycle, function (record) { return addRawRecord(record); });
    return {
        stop: function () {
            stopRecording();
            stopSegmentCollection();
        },
    };
}
exports.startRecording = startRecording;
function trackViewEndRecord(lifeCycle, addRawRecord) {
    lifeCycle.subscribe(browser_rum_core_1.LifeCycleEventType.VIEW_ENDED, function () {
        addRawRecord({
            type: types_1.RecordType.ViewEnd,
        });
    });
}
exports.trackViewEndRecord = trackViewEndRecord;
//# sourceMappingURL=startRecording.js.map